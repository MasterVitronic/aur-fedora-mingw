# Maintainer: Nicola Fontana <ntd@entidi.it>
#
# Port of the Fedora package found at
# http://pkgs.fedoraproject.org/cgit/mingw-tools.git/
# without widl support.

pkgname=fedora-mingw-w64-tools
pkgver=5716
pkgrel=2
pkgdesc='MinGW-w64 gendef and genidl tools'
arch=(any)
url='http://mingw-w64.sourceforge.net'
license=('custom')
groups=('fedora-mingw')
depends=()
makedepends=()
optdepends=()
provides=(mingw-w64-tools)
conflicts=(mingw-w64-tools)
replaces=()
backup=()
options=(!strip !buildflags !libtool)
source=("http://pkgs.fedoraproject.org/cgit/mingw-w64-tools.git/plain/mingw-w64-tools-2.0.999-s390.patch?id=178171478ff0f48e4d538cbb445a348eeeb4e87e")
md5sums=('a6264cd76bca66af28e677ce1e22ae1d')

_svnmod='mingw-w64'
_svntrunk='http://mingw-w64.svn.sourceforge.net/svnroot/mingw-w64/trunk'

build() {
  local svndir="$srcdir/$_svnmod"
  local builddir

  if [[ -d "$svndir/.svn" ]]; then
    cd "$_svnmod"
    svn up -r "$pkgver"
    svn revert -R .
  else
    cd "$srcdir"
    svn co "$_svntrunk" --config-dir ./ -r "$pkgver" "$_svnmod" && cd "$_svnmod"
  fi

  msg "SVN checkout done or server timeout"

  # Apply patches from fedora repository
  cd "$svndir"
  patch -Np2 < '../mingw-w64-tools-2.0.999-s390.patch?id=178171478ff0f48e4d538cbb445a348eeeb4e87e'

  export CFLAGS='-O2 -pipe'
  export CXXFLAGS="$CFLAGS"
  unset  LDFLAGS
  unset  CPPFLAGS

  builddir="$srcdir/$pkgname-$pkgver-build"
  mkdir -p "$builddir/gendef" "$builddir/genidl" "$builddir/widl"
  cd "$builddir/gendef"
  "$svndir/mingw-w64-tools/gendef/configure" --prefix=/usr
  make

  cd "$builddir/genidl"
  "$svndir/mingw-w64-tools/genidl/configure" --prefix=/usr
  make
}

package() {
  local builddir
  builddir="$srcdir/$pkgname-$pkgver-build"

  cd "$builddir/gendef"
  make DESTDIR="$pkgdir" install

  cd "$builddir/genidl"
  make DESTDIR="$pkgdir" install

  install -Dm644 "$srcdir/mingw-w64/mingw-w64-tools/gendef/COPYING" "$pkgdir/usr/share/licenses/mingw-w64/COPYING.gendef"
  install -Dm644 "$srcdir/mingw-w64/mingw-w64-tools/genidl/COPYING" "$pkgdir/usr/share/licenses/mingw-w64/COPYING.genidl"
}

# vim:set ts=2 sw=2 et:
