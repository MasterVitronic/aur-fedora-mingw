From 8ca39485ca6d5e5048a7c693bbf4e7c9e867fa28 Mon Sep 17 00:00:00 2001
From: Nicola Fontana <ntd@entidi.it>
Date: Mon, 23 Mar 2015 22:04:32 +0100
Subject: [PATCH 08/11] Use a launcher to execute g-ir-scanner

In cross-compilation the build system is unable to execute the compiled
binary. Give the possibility to use  a launcher, e.g. wine for MinGW or
qemu for different CPU type.
---
 common.mk                | 6 +++++-
 giscanner/gdumpparser.py | 6 ++++++
 2 files changed, 11 insertions(+), 1 deletion(-)

diff --git a/common.mk b/common.mk
index 59753ee..8187425 100644
--- a/common.mk
+++ b/common.mk
@@ -4,7 +4,7 @@
 # This file defines variables that are compatible with
 # Makefile.introspection, but for use within the gobject-introspection
 # module itself.
-#
+
 
 INTROSPECTION_SCANNER = \
     env PATH=".libs:$(PATH)" \
@@ -24,8 +24,12 @@ INTROSPECTION_SCANNER_ARGS = \
     --add-include-path=$(top_builddir) \
     --add-include-path=$(top_builddir)/gir
 
+# GI_LAUNCHER is the command to use for executing g-ir-compiler.
+# Normally will be undefined but can be set (e.g. to wine or qemu)
+# when cross-compiling
 INTROSPECTION_COMPILER = \
     env PATH=".libs:$(PATH)" \
+        $(GI_LAUNCHER) \
         $(top_builddir)/g-ir-compiler$(EXEEXT)
 
 INTROSPECTION_COMPILER_ARGS = \
diff --git a/giscanner/gdumpparser.py b/giscanner/gdumpparser.py
index 9bdc2bc..6f1ac7a 100644
--- a/giscanner/gdumpparser.py
+++ b/giscanner/gdumpparser.py
@@ -162,6 +162,12 @@ blob containing data gleaned from GObject's primitive introspection."""
         out_path = os.path.join(self._binary.tmpdir, 'dump.xml')
 
         args = []
+
+        # Prepend the launcher command and arguments, if defined
+        launcher = os.environ.get('GI_LAUNCHER')
+        if launcher:
+            args.extend(launcher.split())
+
         args.extend(self._binary.args)
         args.append('--introspect-dump=%s,%s' % (in_path, out_path))
 
-- 
2.7.0

