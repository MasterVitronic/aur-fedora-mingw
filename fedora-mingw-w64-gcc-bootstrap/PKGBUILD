# Maintainer: Nicola Fontana <ntd@entidi.it>
#
# Port of the Fedora package found at
# http://pkgs.fedoraproject.org/cgit/mingw-gcc.git/
# compiled for bootstrapping. It is not intended for general use:
# see ../README.md for details on the bootstrap process.

pkgname=fedora-mingw-w64-gcc-bootstrap
pkgver=4.8.1
pkgrel=2
pkgdesc="Cross GCC for the MinGW-w64 cross-compiler (bootstrap)"
arch=('i686' 'x86_64')
url="http://gcc.gnu.org"
license=('GPL' 'LGPL' 'FDL' 'custom')
groups=('fedora-mingw-bootstrap')
depends=('zlib' 'libmpc' 'cloog'
         'mingw-w64-binutils')
makedepends=('mingw-w64-headers')
optdepends=()
provides=("mingw-w64-gcc=$pkgver")
conflicts=(mingw-w64-gcc)
replaces=()
backup=()
options=(!strip !buildflags !libtool !emptydirs)
source=("ftp://gcc.gnu.org/pub/gcc/releases/gcc-$pkgver/gcc-$pkgver.tar.bz2"
        "http://pkgs.fedoraproject.org/cgit/mingw-gcc.git/plain/gcc-make-xmmintrin-header-cplusplus-compatible.patch?id=5963cd784fc28b8fb9df7ff93270131c36962ec3"
        "http://pkgs.fedoraproject.org/cgit/mingw-gcc.git/plain/gcc-bug-56742-seh-uncaught-throw.patch?id=5963cd784fc28b8fb9df7ff93270131c36962ec3")
md5sums=('3b2386c114cd74185aa3754b58a79304'
         'da6c9ba6baebe1286f3219d4181cdbb8'
         '3d5c4929cbe69911c308d5ec2d66da6d')

_architectures=(i686-w64-mingw32 x86_64-w64-mingw32)

build() {
  local tardir="$srcdir/gcc-$pkgver"
  local builddir
  local arch

  echo 'Fedora-archlinux MinGW $pkgver-$pkgrel' > $tardir/gcc/DEV-PHASE

  # Apply patches from fedora repository
  cd "$tardir"
  # The file xmmintrin.h doesn't contain an extern "C" part
  # This conflicts with mingw-w64 intrin.h and results in build
  # failure like this one in mingw-qt5-qtbase:
  # /usr/lib/gcc/i686-w64-mingw32/4.8.0/include/xmmintrin.h:997:1: error: previous declaration of 'int _m_pextrw(__m64, int)' with 'C++' linkage
  # /usr/i686-w64-mingw32/sys-root/mingw/include/intrin.h:561:28: error: conflicts with new declaration with 'C' linkage
  # http://gcc.gnu.org/bugzilla/show_bug.cgi?id=56038
  patch -Np0 < '../gcc-make-xmmintrin-header-cplusplus-compatible.patch?id=5963cd784fc28b8fb9df7ff93270131c36962ec3'
  # Optimization bug which can lead to uncaught throw (SEH related)
  # http://gcc.gnu.org/bugzilla/show_bug.cgi?id=56742
  patch -Np1 < '../gcc-bug-56742-seh-uncaught-throw.patch?id=5963cd784fc28b8fb9df7ff93270131c36962ec3'

  # using -pipe causes spurious test-suite failures
  # http://gcc.gnu.org/bugzilla/show_bug.cgi?id=48565
  export CFLAGS='-O2'
  export CXXFLAGS="$CFLAGS"
  unset  LDFLAGS
  unset  CPPFLAGS

  for arch in ${_architectures[@]}; do
    builddir="$srcdir/$pkgname-$pkgver-build-$arch"
    mkdir -p "$builddir"
    cd "$builddir"
    $tardir/configure \
        --prefix=/usr \
        --with-gxx-include-dir=/usr/$arch/include/c++ \
        --target=$arch \
        --disable-lto \
        --disable-libgomp \
        --with-gnu-as \
        --with-gnu-ld \
        --without-newlib \
        --disable-multilib \
        --disable-plugin \
        --with-system-zlib \
        --disable-nls \
        --without-included-gettext \
        --disable-win32-registry \
        --enable-languages="c,c++" \
        --with-bugurl=http://bugzilla.redhat.com/bugzilla
    make all-gcc
  done
}

package() {
  local arch

  for arch in ${_architectures[@]}; do
    cd "$srcdir/$pkgname-$pkgver-build-$arch"
    make DESTDIR="$pkgdir" install-gcc
  done

  find "$pkgdir" -name '*.dll' -exec $arch-strip -xg {} +
  find "$pkgdir" -name '*.a' -exec $arch-strip -g {} +
  strip "$pkgdir"/usr/bin/*
  rm -fr "$pkgdir/usr/share"
}

# vim:set ts=2 sw=2 et:
