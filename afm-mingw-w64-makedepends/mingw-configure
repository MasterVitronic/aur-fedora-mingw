# This file is sourced by the configure wrappers: it contains the common
# code between them.
#
# There are four flag types handled by this script: CFLAGS, CPPFLAGS,
# LDFLAGS and CXXFLAGS.
#
# Flags can be set with MINGW_{type} (e.g. MINGW_CPPFLAGS) or injected
# (i.e. appended to the default value) with MINGW_EXTRA_{type}.
#
# There are also 32 and 64 bit variants of all the above variables,
# e.g. MINGW64_EXTRA_FLAGS, with higher precedence than their generic
# counterpart.

# Arguments:
#   architecture:   i686-w64-mingw32 or x86_64-w64-mingw32
#   bits:           32 or 64
#   configure path: path where the configure script resides
#   ...:            additional parameters for configure
call_configure() {
    local arch=$1
    shift

    local bits=$1
    shift

    local path_to_configure=$1
    shift

    # Fallback flags used by AUR Fedora MinGW packages
    local fallback_cflags='-O2 -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 --param=ssp-buffer-size=4'
    local fallback_cppflags=
    local fallback_ldflags=
    local fallback_cxxflags="$fallback_cflags -fexceptions"

    local cflags="MINGW${bits}_CFLAGS"
    local extra_cflags="MINGW${bits}_EXTRA_CFLAGS"
    local cppflags="MINGW${bits}_CPPFLAGS"
    local extra_cppflags="MINGW${bits}_EXTRA_CPPFLAGS"
    local ldflags="MINGW${bits}_LDFLAGS"
    local extra_ldflags="MINGW${bits}_EXTRA_LDFLAGS"
    local cxxflags="MINGW${bits}_CXXFLAGS"
    local extra_cxxflags="MINGW${bits}_EXTRA_CXXFLAGS"

    # Use export instead of passing variables on the command line configure to
    # be fallback compatible with configure generated by old autoconf
    export PATH="/usr/$arch/bin:$PATH"
    export CFLAGS="${!cflags:-${MINGW_CFLAGS:-$fallback_cflags}} ${!extra_cflags:-$MINGW_EXTRA_CFLAGS}"
    export CPPFLAGS="${!cppflags:-${MINGW_CPPFLAGS:-$fallback_cppflags}} ${!extra_cppflags:-$MINGW_EXTRA_CPPFLAGS}"
    export LDFLAGS="${!ldflags:-${MINGW_LDFLAGS:-$fallback_ldflags}} ${!extra_ldflags:-$MINGW_EXTRA_LDFLAGS}"
    export CXXFLAGS="${!cxxflags:-${MINGW_CXXFLAGS:-$fallback_cxxflags}} ${!extra_cxxflags:-$MINGW_EXTRA_CXXFLAGS}"

    "$path_to_configure/configure" \
	--build="$CHOST" \
	--host=$arch \
	--prefix=/usr/$arch \
	"$@"
}
